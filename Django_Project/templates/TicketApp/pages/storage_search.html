{% extends 'new_home/include/_base.html' %}
{% load static %}

{% block stylesheets %}
<style>
  /* Center the main content for better mobile view */
  .main-container {
    max-width: 90%;
    margin: 0 auto;
    padding-top: 1rem;
  }

  /* Make input big for PDA scanning */
  .scan-input {
    width: 100%;
    font-size: 1.5rem;
    padding: 15px;
    margin-bottom: 15px;
    text-align: center;
    border: 2px solid #007bff;
    border-radius: 8px;
  }

  .btn-scan {
    width: 100%;
    font-size: 1.2rem;
    padding: 15px 20px;
    border-radius: 8px;
  }

  /* --- Card Layout for Results --- */
  .results-list {
    margin-top: 25px;
  }

  .result-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #ffffff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .card-item {
    margin-bottom: 10px;
    font-size: 1.1rem;
    line-height: 1.5;
    /* Allow long strings to wrap */
    word-break: break-all;
  }

  .card-item strong {
    display: inline-block;
    min-width: 110px; /* Aligns the labels */
    color: #555;
  }

  /* Status-specific styling */
  .status {
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 5px;
    color: white;
  }
  .status-pending {
    background-color: #ffc107; /* Amber */
  }
  .status-shipped {
    background-color: #28a745; /* Green */
  }
  .status-default {
    background-color: #6c757d; /* Gray */
  }

  .card-actions {
    margin-top: 15px;
    border-top: 1px solid #eee;
    padding-top: 15px;
    display: flex;
    flex-direction: column; /* Stack buttons vertically */
    gap: 10px; /* Space between buttons */
  }

  .card-actions .btn {
      width: 100%; /* Make buttons full-width */
      text-align: center;
  }

  .shipped-message {
      color: #28a745;
      font-weight: bold;
      text-align: center;
      padding: 10px;
      background-color: #e9f5ec;
      border-radius: 5px;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="main-container">

  <!-- Flash Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} messages" role="alert">
        <li>
          {% if message.tags == "success" %}
            <i class="fas fa-check"></i>
          {% else %}
            <i class="fas fa-times"></i>
          {% endif %}
          {{ message }}
        </li>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Unified Scan Search -->
  <h2 class="text-center">Scan BOL or Bin</h2>
  <form method="get" id="scan_form">
    <input type="text" name="scan_code" class="scan-input"
           placeholder="BOL# or Bin# here..."
           autofocus>
    <button type="submit" name="scan" id="scan_button" class="btn btn-primary btn-scan">Search</button>
  </form>

  {% if results %}
    <h3 class="mt-4">Search Results:</h3>
    <div class="results-list">
      {% for record in results %}
        <div class="result-card">
          <div class="card-item"><strong>Picking#:</strong> {{ record.picking_no }}</div>
          <div class="card-item"><strong>BOL#:</strong> {{ record.bol_no }}</div>
          <div class="card-item"><strong>Bin#:</strong> {{ record.location_code }}</div>
          <div class="card-item"><strong>Pallet Qty:</strong> {{ record.pallet_qty }}</div>
          <div class="card-item">
              <strong>Status:</strong>
              {% if record.status == "Pending" %}
                <span class="status status-pending">Pending</span>
              {% elif record.status == "Shipped" %}
                <span class="status status-shipped">Shipped</span>
              {% else %}
                <span class="status status-default">{{ record.status|capfirst }}</span>
              {% endif %}
          </div>
          <div class="card-actions">
            {% if record.status == "Pending" %}
              <a class="btn btn-success"
                 href="{% url 'TicketApp:storage_confirm' record.id %}">Confirm Shipment</a>
            {% else %}
              <div class="shipped-message">Already Shipped</div>
            {% endif %}
            <a class="btn btn-info"
               href="{% url 'TicketApp:storage_logs' record.id %}">View Logs</a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock content %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const scanInput = document.querySelector('.scan-input');
    const scanForm = document.getElementById('scan_form');
    const scanButton = document.getElementById('scan_button');

    // Check if the required elements exist on the page
    if (!scanInput || !scanForm) {
        console.error('Error: Could not find the scan input or form element.');
        return; // Stop the script if elements are missing
    }

    scanInput.addEventListener('keypress', function (e) {
      // This log will appear for ANY key press in the input field.
      // Helps confirm the event listener is attached and working.
      console.log('Keydown event detected. Key code:', e.keyCode);

      // We only care about the 'Enter' key, which has a key code of 13.
      if (e.keyCode === 13) {
        console.log('Enter key (keyCode 13) detected. Preventing default and submitting.');

        // This is the most critical line. It stops the browser's default
        // behavior, which is to refresh the page.
        e.preventDefault();

        // As requested, programmatically click the search button instead of submitting the form.
        scanButton.click();
      }
    });


    // --- Page Lifecycle Management ---
    function focusAndSelectInput() {
        if(scanInput) {
            scanInput.focus();
            // Using a short timeout for select() can help on some mobile browsers
            setTimeout(() => scanInput.select(), 0);
        }
    }

    // Initial focus when the page loads
    focusAndSelectInput();

    // Refocus when the page is shown (e.g., after back button or submission)
    window.addEventListener('pageshow', function () {
      focusAndSelectInput();
    });

  });
</script>
{% endblock scripts %}
